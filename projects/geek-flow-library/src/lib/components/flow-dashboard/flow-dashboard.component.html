<div class="dashboard-container">
  <header class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center">
      <h1 class="h3 mb-0">My Workflows</h1>
      <div class="d-flex gap-2 align-items-center">
        <span class="text-muted">{{ activeCount() }} active</span>
        <button
          class="btn btn-primary"
          (click)="showCreateForm.set(true)"
          [attr.aria-expanded]="showCreateForm()">
          + New Flow
        </button>
      </div>
    </div>

    @if (showCreateForm()) {
      <div class="create-form mt-3" role="form" aria-label="Create new flow">
        <div class="input-group">
          <input
            type="text"
            class="form-control"
            placeholder="Flow name..."
            [ngModel]="newFlowName()"
            (ngModelChange)="newFlowName.set($event)"
            (keyup.enter)="createFlow()"
            aria-label="Flow name" />
          <button class="btn btn-success" (click)="createFlow()">Create</button>
          <button class="btn btn-outline-secondary" (click)="showCreateForm.set(false)">Cancel</button>
        </div>
      </div>
    }
  </header>

  @if (error()) {
    <div class="alert alert-danger mt-3" role="alert">
      {{ error() }}
      <button class="btn-close float-end" (click)="error.set(null)" aria-label="Dismiss"></button>
    </div>
  }

  @if (isLoading()) {
    <div class="text-center py-5" role="status">
      <div class="spinner-border" aria-hidden="true"></div>
      <span class="visually-hidden">Loading flows...</span>
    </div>
  } @else {
    <div class="flow-list mt-3">
      @for (flow of flows(); track flow.id) {
        <div
          class="flow-card card mb-2"
          [class.border-primary]="selectedFlowId() === flow.id"
          role="button"
          tabindex="0"
          (click)="selectFlow(flow.id)"
          (keyup.enter)="selectFlow(flow.id)"
          [attr.aria-selected]="selectedFlowId() === flow.id">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title mb-1">{{ flow.name }}</h5>
              <div class="d-flex gap-2 align-items-center">
                <span [class]="getStatusClass(flow.status)">{{ flow.status }}</span>
                <small class="text-muted">{{ flow.stepCount }} steps</small>
                @if (flow.lastRun) {
                  <small class="text-muted">
                    Last run: {{ flow.lastRun.status }}
                  </small>
                }
              </div>
            </div>
            <div class="d-flex gap-1">
              <button
                class="btn btn-sm btn-outline-primary"
                (click)="openFlow(flow.id); $event.stopPropagation()"
                aria-label="Edit flow">
                Edit
              </button>
              <button
                class="btn btn-sm"
                [class.btn-outline-warning]="flow.status === 'ACTIVE'"
                [class.btn-outline-success]="flow.status !== 'ACTIVE'"
                (click)="toggleFlowStatus(flow); $event.stopPropagation()"
                [attr.aria-label]="flow.status === 'ACTIVE' ? 'Pause flow' : 'Activate flow'">
                {{ flow.status === 'ACTIVE' ? 'Pause' : 'Activate' }}
              </button>
              <button
                class="btn btn-sm btn-outline-secondary"
                (click)="duplicateFlow(flow.id); $event.stopPropagation()"
                aria-label="Duplicate flow">
                Copy
              </button>
              <button
                class="btn btn-sm btn-outline-danger"
                (click)="deleteFlow(flow.id); $event.stopPropagation()"
                aria-label="Delete flow">
                Delete
              </button>
            </div>
          </div>
        </div>
      } @empty {
        <div class="text-center py-5 text-muted">
          <p class="mb-2">No workflows yet.</p>
          <button class="btn btn-primary" (click)="showCreateForm.set(true)">
            Create your first flow
          </button>
        </div>
      }
    </div>

    @if (selectedFlow()) {
      <div class="mt-3">
        <gf-run-history [flowId]="selectedFlow()!.id" />
      </div>
    }
  }
</div>
