generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Plan {
  FREE
  STARTER
  PRO
}

enum FlowStatus {
  DRAFT
  ACTIVE
  PAUSED
  ERROR
}

enum StepType {
  TRIGGER
  ACTION
  CONDITION
  DELAY
  TRANSFORM
}

enum RunStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  plan      Plan     @default(FREE)
  flowLimit Int      @default(5)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  flows        Flow[]
  integrations UserIntegration[]

  @@map("users")
}

model Flow {
  id           String     @id @default(cuid())
  userId       String
  name         String
  description  String?
  status       FlowStatus @default(DRAFT)
  trigger      Json
  connections  Json       @default("[]")
  canvasLayout Json?
  schedule     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  user  User   @relation(fields: [userId], references: [id])
  steps Step[]
  runs  Run[]

  @@index([userId])
  @@map("flows")
}

model Step {
  id           String   @id @default(cuid())
  flowId       String
  order        Int
  type         StepType
  adapter      String
  action       String
  config       Json     @default("{}")
  inputMapping Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  flow Flow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([flowId])
  @@map("steps")
}

model Run {
  id          String    @id @default(cuid())
  flowId      String
  status      RunStatus @default(PENDING)
  triggerData Json?
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  error       String?

  flow Flow     @relation(fields: [flowId], references: [id])
  logs RunLog[]

  @@index([flowId])
  @@map("runs")
}

model RunLog {
  id        String   @id @default(cuid())
  runId     String
  stepId    String
  status    String
  input     Json?
  output    Json?
  error     String?
  duration  Int?
  createdAt DateTime @default(now())

  run Run @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@map("run_logs")
}

model UserIntegration {
  id          String   @id @default(cuid())
  userId      String
  adapter     String
  credentials Json
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, adapter])
  @@map("user_integrations")
}
